<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USE OF ENGLISH — Interactive C1 Exercises (Complete)</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-1:#071227;
      --bg-2:#0b1e2b;
      --accent-1:#7ee7c1;
      --accent-2:#8bd0ff;
      --fun-1:#ffd27a;
      --ui-shadow: 0 18px 50px rgba(6,12,28,0.6);
      --card-radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(800px 360px at 10% 12%, rgba(139,208,255,0.03), transparent 6%),
        linear-gradient(180deg,var(--bg-1), var(--bg-2));
      color:#eefaf6;
      -webkit-font-smoothing:antialiased;
      padding:26px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Layout */
    .wrap{
      width:min(1200px,96vw);
      height:min(880px,96vh);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:18px;
      padding:20px;
      box-shadow: var(--ui-shadow);
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:20px;
      overflow:hidden;
    }

    /* Left menu */
    .menu{
      padding:18px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.04);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .title h1{ margin:0; font-family: Inter, "Playfair Display", serif; font-weight:600; font-size:20px; }
    .title p{ margin:0; color:rgba(230,238,246,0.7); font-size:13px; }

    .tiles{ display:grid; gap:12px; margin-top:6px; }
    .tile{
      display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease;
      border:1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.005));
    }
    .tile:hover{ transform: translateY(-6px); box-shadow: 0 16px 36px rgba(2,6,23,0.45); border-color: rgba(139,208,255,0.12); }
    .tile .icon{ width:56px; height:56px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:700; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); }

    .note{ color:rgba(230,238,246,0.7); font-size:13px; margin-top:auto }

    /* Right content */
    .content{
      padding:18px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      overflow:auto;
      position:relative;
    }

    .header{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .header-left h2{ margin:0; font-size:20px; font-family:Inter, system-ui; }
    .header-left p{ margin:0; color:rgba(230,238,246,0.68); font-size:13px; }

    .btn{ padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; border:1px solid rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:#ecfff6 }
    .btn:hover{ transform: translateY(-4px); box-shadow: 0 14px 36px rgba(2,6,23,0.35) }

    .panel{
      margin-top:16px;
      padding:18px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid rgba(255,255,255,0.02);
    }

    /* Question card */
    .qcard{ padding:18px; border-radius:12px; min-height:200px; display:flex; flex-direction:column; gap:12px; }
    .q-idx{ color:rgba(230,238,246,0.7); font-size:13px }
    .sentence{ font-size:18px; color:#f8fff8; line-height:1.5 }
    .options{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px }
    .opt{ padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background: rgba(255,255,255,0.01); cursor:pointer; }
    .opt:hover{ transform: translateY(-6px); box-shadow: 0 12px 30px rgba(2,6,23,0.25); }
    .opt.selected{ outline:3px solid rgba(139,208,255,0.12); background: rgba(139,208,255,0.03) }
    .bottom{ display:flex; justify-content:space-between; align-items:center; margin-top:10px }

    .progress{ height:10px; background: rgba(255,255,255,0.03); border-radius:12px; overflow:hidden; width:40% }
    .progress > i{ display:block; height:100%; width:0; background: linear-gradient(90deg,var(--accent-1),var(--accent-2)); transition: width .45s cubic-bezier(.2,.9,.3,1) }

    /* Input styles */
    .gap-input, .word-input, .trans-input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.01);
      color:#f7fff8;
      font-size:15px;
    }
    .small-muted{ color:rgba(230,238,246,0.7); font-size:13px }

    /* Score card */
    .score-card{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%) scale(.95);
      width:min(680px,94%);
      border-radius:14px;
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 26px 70px rgba(2,6,23,0.6);
      z-index:60;
      display:none;
      flex-direction:column;
      gap:12px;
      align-items:center;
      text-align:center;
    }
    .score-card.show{ display:flex; animation:pop .35s cubic-bezier(.2,.9,.3,1) forwards; }
    @keyframes pop { from{ opacity:0; transform: translate(-50%,-50%) scale(.95) } to{ opacity:1; transform: translate(-50%,-50%) scale(1) } }
    .score-number{ font-size:56px; font-weight:700; font-family:Inter, "Playfair Display", serif; color:#fff }
    .score-sub{ color:rgba(230,238,246,0.7) }

    .answers-list{ width:100%; max-height:260px; overflow:auto; text-align:left; border-radius:10px; padding:10px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02) }
    .answer-item{ padding:8px 6px; border-bottom:1px dashed rgba(255,255,255,0.02) }
    .answer-item:last-child{ border-bottom:none }

    /* Kid-friendly cues */
    .fun-badge{ display:inline-block; padding:6px 10px; border-radius:999px; background: linear-gradient(90deg,var(--fun-1), #ff9f6b); color:#111; font-weight:700; font-size:13px }

    /* Responsive */
    @media (max-width:980px){
      .wrap{ grid-template-columns: 1fr; height:auto; padding:12px }
      .menu{ order:2 }
      .content{ order:1 }
    }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Use of English interactive slide">
    <!-- LEFT menu -->
    <aside class="menu" aria-label="Menu">
      <div class="title">
        <div>
          <h1>USE OF ENGLISH <span class="fun-badge">C1</span></h1>
          <p class="small-muted">Exam-style practice — friendly UI for young learners</p>
        </div>
      </div>

      <div class="tiles" role="list">
        <div class="tile" role="listitem" tabindex="0" data-target="mc">
          <div class="icon">A</div>
          <div>
            <div style="font-weight:700">Multiple Choice</div>
            <div class="small-muted">12 exam-style sentences</div>
          </div>
        </div>

        <div class="tile" role="listitem" tabindex="0" data-target="gap">
          <div class="icon">B</div>
          <div>
            <div style="font-weight:700">Gap-fill</div>
            <div class="small-muted">12 cloze items — collocations, connectors</div>
          </div>
        </div>

        <div class="tile" role="listitem" tabindex="0" data-target="word">
          <div class="icon">C</div>
          <div>
            <div style="font-weight:700">Word Formation</div>
            <div class="small-muted">12 derivation items</div>
          </div>
        </div>

        <div class="tile" role="listitem" tabindex="0" data-target="trans">
          <div class="icon">D</div>
          <div>
            <div style="font-weight:700">Sentence Transformation</div>
            <div class="small-muted">12 paraphrase prompts</div>
          </div>
        </div>
      </div>

      <div class="note small-muted">
        One mark per correct answer. Use <strong>NEXT</strong> and <strong>RETURN TO MENU</strong>. Animated score and answer explanations at the end.
      </div>
    </aside>

    <!-- RIGHT content -->
    <main class="content" id="content" aria-live="polite">
      <div class="header">
        <div class="header-left">
          <h2 id="exercise-title">Welcome</h2>
          <p id="exercise-sub" class="small-muted">Choose an exercise to begin. All content is C1 level.</p>
        </div>
        <div>
          <button class="btn" id="return-menu" style="display:none">RETURN TO MENU</button>
        </div>
      </div>

      <div id="main-area" class="panel">
        <div style="text-align:center; padding:28px;">
          <h3 style="font-weight:700; margin:0 0 8px 0; font-family:Inter, sans-serif;">Ready for a challenge?</h3>
          <p class="small-muted" style="max-width:72ch; margin:12px auto;">
            Start with <strong>Multiple Choice</strong> to experience the full 12-item exam-style run. When you finish any exercise you'll see a bright animated score card with answers and short explanations.
          </p>
        </div>
      </div>
    </main>
  </div>

  <!-- Score card (shared) -->
  <div class="score-card" id="scoreCard" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="score-number" id="scoreNumber">0 / 0</div>
    <div class="score-sub" id="scorePercent">0% — Keep going!</div>

    <div style="display:flex; gap:10px">
      <button class="btn" id="revealAnswers">Show answers & explanations</button>
      <button class="btn" id="closeScore">Close</button>
    </div>

    <div class="answers-list" id="answersList" style="display:none"></div>
  </div>

  <script>
    /************************************************************************
     * DATA: All four exercises (12 items each) + acceptable answer variants
     ************************************************************************/

    // MULTIPLE CHOICE (12)
    const MULTIPLE_CHOICE = [
      { sentence: "Hardly had the committee ___ the proposal when disagreements began to surface.",
        options:["adopted","was adopting","had adopted","have adopted"], correct:0,
        explain:"Inversion: 'Hardly had ...' pairs with simple past 'adopted' (structure: Hardly had X done Y when...)."
      },
      { sentence: "Her explanation was so ___ that even those unfamiliar with the topic could follow it.",
        options:["lucidly","lucid","lucidity","lucidness"], correct:1,
        explain:"Adjective needed to modify 'explanation' — 'lucid'."
      },
      { sentence: "They will not consider the application until you have provided the necessary ___.",
        options:["documentation","document","documentary","documents"], correct:0,
        explain:"'Documentation' (uncountable) is the idiomatic phrase."
      },
      { sentence: "It’s high time we ___ a more sustainable approach to urban transport.",
        options:["took up","take on","took on","had taken"], correct:2,
        explain:"'It's high time' uses past tense to express present obligation: 'we took on' (adopt)."
      },
      { sentence: "His behaviour was the result of ___ judgement rather than malice.",
        options:["flawed","flaw","flawless","flaws"], correct:0,
        explain:"Adjective 'flawed judgement' describes the judgement."
      },
      { sentence: "No sooner ___ the advocate finished than the judge interrupted with a question.",
        options:["had","did","has","was"], correct:0,
        explain:"'No sooner had ... than' inversion — 'had' is correct."
      },
      { sentence: "The committee postponed the vote, ___ they could study the evidence more thoroughly.",
        options:["so that","despite","although","because of"], correct:0,
        explain:"'So that' indicates purpose."
      },
      { sentence: "Her argument was elegant and persuasive; it ___ all previous objections.",
        options:["dispelled","compromised","subverted","disposed"], correct:0,
        explain:"An argument can 'dispel' objections."
      },
      { sentence: "The new regulation imposes an additional burden on firms ___ with compliance.",
        options:["struggling","to struggle","strugglingly","struggled"], correct:0,
        explain:"Present participle 'struggling with' modifies 'firms'."
      },
      { sentence: "He insisted that the changes be implemented ___ delay.",
        options:["in","at","with","without"], correct:3,
        explain:"Idiom: 'without delay' = immediately."
      },
      { sentence: "The film received ___ reviews, but audiences loved it.",
        options:["capricious","mixed","commensurate","din"], correct:1,
        explain:"'Mixed reviews' is the common collocation."
      },
      { sentence: "She has a reputation for being forthright; ___ , colleagues appreciate her honesty.",
        options:["conversely","nevertheless","moreover","hence"], correct:2,
        explain:"'Moreover' adds supporting information."
      }
    ];

    // GAP-FILL (12)
    // Each item: sentence with a single blank marker '___' and array of acceptable answers (lowercased)
    const GAP_FILL = [
      { sentence: "___ the mounting evidence, the council refused to alter the decision.", answers:["despite", "in spite of"] , explain:"'Despite' or 'In spite of' + noun phrase." },
      { sentence: "She argued that any decision should be made on the ___ of objective criteria.", answers:["basis"], explain:"'On the basis of' — 'basis' is expected." },
      { sentence: "We must take steps to ___ the risk of data breaches in our systems.", answers:["mitigate","reduce"], explain:"'Mitigate' or 'reduce' the risk." },
      { sentence: "The proposal was rejected ___ concerns about feasibility and cost.", answers:["amid","amidst"], explain:"'Amid/Amidst concerns' is idiomatic." },
      { sentence: "The scientist's findings lend strong ___ to the theory.", answers:["support","credence"], explain:"'lend support/credence to'." },
      { sentence: "Her promotion was the ___ consequence of years of consistent hard work.", answers:["natural","direct"], explain:"'Natural consequence' fits best; 'direct' also possible depending on phrasing." },
      { sentence: "Companies are increasingly judged by their approach to ___ responsibility.", answers:["corporate","corporate social"], explain:"'Corporate responsibility' (or 'corporate social') — accept 'corporate'." },
      { sentence: "He completed the task ___ meticulous attention to detail.", answers:["with"], explain:"'with meticulous attention to detail'." },
      { sentence: "The two reports are ___ in their conclusions.", answers:["consistent","similar"], explain:"'consistent'/'similar' in meaning." },
      { sentence: "The new system will require staff to ___ to a different workflow.", answers:["adapt","adjust"], explain:"'adapt to' or 'adjust to' a workflow." },
      { sentence: "Her evidence was pivotal and ___ the prosecution's case.", answers:["strengthened","bolstered","supported"], explain:"'bolster/strengthen/support' the case." },
      { sentence: "Our aim is to strike a ___ between innovation and safety.", answers:["balance"], explain:"'strike a balance between'." }
    ];

    // WORD FORMATION (12)
    // prompt: base, target (e.g., 'economy' -> 'economic (adj)'), answers array
    const WORD_FORM = [
      { base:"economy", target:"(adj)", answers:["economic","economical"], explain:"'economic' (relating to the economy); 'economical' means not wasteful — accept 'economic' primarily." },
      { base:"obvious", target:"(n)", answers:["obviousness","obviousity"], explain:"'obviousness' is natural." },
      { base:"create", target:"(n)", answers:["creation","creativity"], explain:"Either 'creation' (act) or 'creativity' (quality) depending on prompt; primary: 'creation'." },
      { base:"decide", target:"(adj)", answers:["decisive"], explain:"'decisive' = showing decision/ability; 'decided' could appear, but 'decisive' expected." },
      { base:"responsible", target:"(n)", answers:["responsibility"], explain:"Derivation: 'responsibility'." },
      { base:"succeed", target:"(n)", answers:["success"], explain:"'success'." },
      { base:"apply", target:"(n)", answers:["application"], explain:"'application'." },
      { base:"innovate", target:"(n)", answers:["innovation"], explain:"'innovation'." },
      { base:"depend", target:"(adj)", answers:["dependent","dependable"], explain:"'dependent' or 'dependable' depending on meaning — expect 'dependent'." },
      { base:"compete", target:"(n)", answers:["competition","competitor"], explain:"'competition' (process) or 'competitor' (one who competes). 'Competition' expected." },
      { base:"sustain", target:"(adj)", answers:["sustainable"], explain:"'sustainable'." },
      { base:"inform", target:"(n)", answers:["information"], explain:"'information'." }
    ];

    // SENTENCE TRANSFORMATION (12)
    // Each: origin (for reference), prompt text shown, key: array of acceptable normalized answers (lowercased)
    // Cambridge style: give a word that must be used exactly (in key we allow variations)
    const TRANSFORM = [
      { origin:"I don't think it was necessary for you to apologise.",
        prompt:"You needn't have ___ (APOLOGISE)", key:["apologised","apologized"], explain:"Correct: 'You needn't have apologised.' (British/US spelling variants accepted)" },
      { origin:"It is not until you read the contract that you will see the problem.",
        prompt:"Only when ___ the contract did she see the problem. (READ)", key:["she read","you read","they read"], explain:"Typical construction: 'Only when she read the contract did she see the problem.' We'll accept reasonable subject variants if matching structure." },
      { origin:"He didn't know the reasons, so he couldn't comment.",
        prompt:"Had he ___ the reasons, he could have commented. (KNOWN)", key:["known","been aware of"], explain:"Inversion / third conditional: 'Had he known the reasons...'" },
      { origin:"I didn't meet her until after the meeting started.",
        prompt:"Not until after the meeting ___ her. (MEET)", key:["did i meet","i met","did i meet her"], explain:"'Not until after the meeting did I meet her.' or 'I didn't meet her until after the meeting started.' Accept equivalent structures." },
      { origin:"They finally agreed to the proposal after much discussion.",
        prompt:"Only after much discussion ___ to the proposal. (AGREE)", key:["did they agree","they agreed"], explain:"'Only after much discussion did they agree to the proposal.' or 'They agreed to the proposal only after much discussion.' " },
      { origin:"I don't remember seeing him at the conference.",
        prompt:"I have no ___ of seeing him at the conference. (RECOLLECTION)", key:["recollection","memory"], explain:"'no recollection' fits; 'memory' acceptable." },
      { origin:"Although she was inexperienced, she did well.",
        prompt:"In spite of her ___, she did well. (INEXPERIENCE)", key:["inexperience"], explain:"'In spite of her inexperience, she did well.' " },
      { origin:"You mustn't forget to lock the door.",
        prompt:"Don't forget ___ the door. (LOCK)", key:["to lock","locking"], explain:"'Don't forget to lock the door.' 'Don't forget locking' less natural — accept 'to lock' primarily." },
      { origin:"He regretted that he had accepted the offer.",
        prompt:"He regretted ___ the offer. (ACCEPT)", key:["accepting"], explain:"'He regretted accepting the offer.' " },
      { origin:"They made him apologise for the mistake.",
        prompt:"He was ___ to apologise for the mistake. (FORCED)", key:["forced","compelled"], explain:"'He was forced to apologise.' 'He was compelled to apologise.' both acceptable." },
      { origin:"I could not believe how fast the time went by.",
        prompt:"I was amazed ___ how fast the time went by. (AT)", key:["at","by"], explain:"'I was amazed at how fast the time went by.' 'Amazed by' also possible." },
      { origin:"Tom hadn't realised the problem until it was too late.",
        prompt:"Only when the problem ___ did Tom realise. (BE)", key:["had occurred","occurred","had arisen"], explain:"'Only when the problem had occurred/did occur did Tom realise.' Accept 'occurred'/'had occurred'/'had arisen'." }
    ];

    /************************************************************************
     * STATE
     ************************************************************************/
    const tiles = document.querySelectorAll('.tile');
    const contentTitle = document.getElementById('exercise-title');
    const contentSub = document.getElementById('exercise-sub');
    const mainArea = document.getElementById('main-area');
    const returnBtn = document.getElementById('return-menu');
    const scoreCard = document.getElementById('scoreCard');
    const scoreNumber = document.getElementById('scoreNumber');
    const scorePercent = document.getElementById('scorePercent');
    const answersList = document.getElementById('answersList');
    const revealAnswersBtn = document.getElementById('revealAnswers');
    const closeScoreBtn = document.getElementById('closeScore');

    let current = null;

    // per-exercise state
    let mcState = { idx:0, answers: Array(MULTIPLE_CHOICE.length).fill(null) };
    let gapState = { idx:0, answers: Array(GAP_FILL.length).fill("") };
    let wordState = { idx:0, answers: Array(WORD_FORM.length).fill("") };
    let transState = { idx:0, answers: Array(TRANSFORM.length).fill("") };

    /************************************************************************
     * HELPERS
     ************************************************************************/
    function clearMain(){ mainArea.innerHTML = ''; }
    function showMenu(){
      current = null;
      contentTitle.textContent = 'Welcome';
      contentSub.textContent = 'Choose an exercise to begin.';
      returnBtn.style.display = 'none';
      hideScore();
      clearMain();
      mainArea.innerHTML = `
        <div style="text-align:center; padding:28px;">
          <h3 style="font-weight:700; margin:0 0 8px 0;">Pick a section and let's get practising!</h3>
          <p class="small-muted" style="max-width:72ch; margin:12px auto;">Multiple Choice contains 12 C1 exam-style sentences. The other sections are fully interactive and auto-scoring with answer keys and explanations at the end.</p>
        </div>`;
    }

    /************************************************************************
     * MULTIPLE CHOICE LOGIC (existing behaviour)
     ************************************************************************/
    function startMC(){
      current = 'mc';
      mcState.idx = 0;
      mcState.answers = Array(MULTIPLE_CHOICE.length).fill(null);
      contentTitle.textContent = 'Multiple Choice — 12 items (C1)';
      contentSub.textContent = 'Choose the best option (A–D). 1 mark each.';
      returnBtn.style.display = 'inline-flex';
      renderMC();
    }

    function renderMC(){
      const idx = mcState.idx;
      const q = MULTIPLE_CHOICE[idx];
      clearMain();

      const wrapper = document.createElement('div');
      wrapper.className = 'qcard';
      wrapper.innerHTML = `
        <div class="q-idx">Question ${idx+1} of ${MULTIPLE_CHOICE.length}</div>
        <div class="sentence">${q.sentence.replace('___','<strong style="text-decoration:underline">______</strong>')}</div>
        <div class="options" role="list">
          ${q.options.map((opt,i)=>`<div class="opt" data-opt="${i}" tabindex="0"><strong>${String.fromCharCode(65+i)}.</strong> &nbsp; ${opt}</div>`).join('')}
        </div>
        <div class="bottom">
          <div style="display:flex; gap:8px;">
            <button class="btn" id="prevQ" ${idx===0?'disabled':''}>Previous</button>
            <button class="btn" id="nextQ">Next</button>
          </div>
          <div class="progress"><i style="width:${Math.round((idx/MULTIPLE_CHOICE.length)*100)}%"></i></div>
        </div>
      `;
      mainArea.appendChild(wrapper);

      const opts = mainArea.querySelectorAll('.opt');
      opts.forEach(el=>{
        el.addEventListener('click', ()=> {
          const selected = Number(el.dataset.opt);
          mcState.answers[idx] = selected;
          opts.forEach(x=>x.classList.remove('selected'));
          el.classList.add('selected');
        });
        el.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'||ev.key===' ') { ev.preventDefault(); el.click(); }});
      });

      // restore if present
      const prev = mcState.answers[idx];
      if(prev !== null){
        const el = mainArea.querySelector(`.opt[data-opt="${prev}"]`);
        if(el) el.classList.add('selected');
      }

      document.getElementById('prevQ').onclick = ()=>{ if(mcState.idx>0){ mcState.idx--; renderMC(); } };
      document.getElementById('nextQ').onclick = ()=>{ if(mcState.idx === MULTIPLE_CHOICE.length - 1){ finishMC(); } else { mcState.idx++; renderMC(); } };
    }

    function finishMC(){
      const total = MULTIPLE_CHOICE.length;
      let score = 0;
      const items = [];
      for(let i=0;i<total;i++){
        const user = mcState.answers[i];
        const q = MULTIPLE_CHOICE[i];
        const ok = user === q.correct;
        if(ok) score++;
        items.push({ qnum:i+1, user: user===null?null:String.fromCharCode(65+user), correct:String.fromCharCode(65+q.correct), explanation:q.explain });
      }
      showScore(score, total, items);
    }

    /************************************************************************
     * GAP-FILL LOGIC (text inputs)
     ************************************************************************/
    function startGap(){
      current = 'gap';
      gapState.idx = 0;
      gapState.answers = Array(GAP_FILL.length).fill("");
      contentTitle.textContent = 'Gap-fill — 12 items (C1)';
      contentSub.textContent = 'Type the missing words/phrases. 1 mark each.';
      returnBtn.style.display = 'inline-flex';
      renderGap();
    }

    function normalizeAnswer(s){
      if(!s && s!=='') return '';
      return s.trim().toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s+/g," ");
    }

    function renderGap(){
      const idx = gapState.idx;
      const item = GAP_FILL[idx];
      clearMain();

      const html = document.createElement('div');
      html.className = 'qcard';
      html.innerHTML = `
        <div class="q-idx">Gap ${idx+1} of ${GAP_FILL.length}</div>
        <div class="sentence">${item.sentence.replace('___','<input type="text" id="gapInput" class="gap-input" aria-label="Gap input">')}</div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
          <div style="color:rgba(230,238,246,0.7); font-size:13px">Tip: answers are case-insensitive; common variants accepted.</div>
          <div style="display:flex; gap:8px;">
            <button class="btn" id="prevGap" ${idx===0?'disabled':''}>Previous</button>
            <button class="btn" id="nextGap">Next</button>
          </div>
        </div>
      `;
      mainArea.appendChild(html);

      const input = document.getElementById('gapInput');
      input.value = gapState.answers[idx] || '';
      input.focus();

      document.getElementById('prevGap').onclick = ()=>{ gapState.answers[idx] = input.value; if(idx>0){ gapState.idx--; renderGap(); } };
      document.getElementById('nextGap').onclick = ()=>{ gapState.answers[idx] = input.value; if(gapState.idx === GAP_FILL.length - 1){ finishGap(); } else { gapState.idx++; renderGap(); } };

      input.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter'){ document.getElementById('nextGap').click(); }});
    }

    function finishGap(){
      const total = GAP_FILL.length;
      let score = 0;
      const items = [];
      for(let i=0;i<total;i++){
        const userRaw = gapState.answers[i] || "";
        const user = normalizeAnswer(userRaw);
        const valid = GAP_FILL[i].answers.map(x=>normalizeAnswer(x));
        const ok = valid.includes(user);
        if(ok) score++;
        items.push({ qnum:i+1, user:userRaw || null, correct:GAP_FILL[i].answers.join(' / '), isCorrect:ok, explanation:GAP_FILL[i].explain });
      }
      showScore(score, total, items);
    }

    /************************************************************************
     * WORD FORMATION LOGIC
     ************************************************************************/
    function startWord(){
      current = 'word';
      wordState.idx = 0;
      wordState.answers = Array(WORD_FORM.length).fill("");
      contentTitle.textContent = 'Word Formation — 12 items';
      contentSub.textContent = 'Form the word requested (e.g., economy → economic). 1 mark each.';
      returnBtn.style.display = 'inline-flex';
      renderWord();
    }

    function renderWord(){
      const idx = wordState.idx;
      const it = WORD_FORM[idx];
      clearMain();

      const html = document.createElement('div');
      html.className = 'qcard';
      html.innerHTML = `
        <div class="q-idx">Item ${idx+1} of ${WORD_FORM.length}</div>
        <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
          <div style="min-width:160px; padding:12px; border-radius:10px; background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02);">
            <div style="font-size:15px; color:rgba(230,238,246,0.8)"><strong>${it.base}</strong> → <em>${it.target}</em></div>
          </div>

          <div style="flex:1">
            <input id="wordInput" class="word-input" placeholder="Type the correct form here">
            <div class="small-muted" style="margin-top:8px">Accepts common variants. Press Enter to move next.</div>
          </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
          <button class="btn" id="prevWord" ${idx===0?'disabled':''}>Previous</button>
          <button class="btn" id="nextWord">Next</button>
        </div>
      `;
      mainArea.appendChild(html);

      const input = document.getElementById('wordInput');
      input.value = wordState.answers[idx] || '';
      input.focus();

      document.getElementById('prevWord').onclick = ()=>{ wordState.answers[idx] = input.value; if(idx>0){ wordState.idx--; renderWord(); } };
      document.getElementById('nextWord').onclick = ()=>{ wordState.answers[idx] = input.value; if(wordState.idx === WORD_FORM.length - 1){ finishWord(); } else { wordState.idx++; renderWord(); } };

      input.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter'){ document.getElementById('nextWord').click(); }});
    }

    function finishWord(){
      const total = WORD_FORM.length;
      let score = 0;
      const items = [];
      for(let i=0;i<total;i++){
        const raw = wordState.answers[i] || "";
        const user = normalizeAnswer(raw);
        const valid = WORD_FORM[i].answers.map(x=>normalizeAnswer(x));
        const ok = valid.includes(user);
        if(ok) score++;
        items.push({ qnum:i+1, user:raw||null, correct:WORD_FORM[i].answers.join(' / '), isCorrect:ok, explanation:WORD_FORM[i].explain });
      }
      showScore(score, total, items);
    }

    /************************************************************************
     * SENTENCE TRANSFORMATION LOGIC
     ************************************************************************/
    function startTrans(){
      current = 'trans';
      transState.idx = 0;
      transState.answers = Array(TRANSFORM.length).fill("");
      contentTitle.textContent = 'Sentence Transformation — 12 items';
      contentSub.textContent = 'Paraphrase using the word given. Keep the meaning. 1 mark each.';
      returnBtn.style.display = 'inline-flex';
      renderTrans();
    }

    function renderTrans(){
      const idx = transState.idx;
      const it = TRANSFORM[idx];
      clearMain();

      const html = document.createElement('div');
      html.className = 'qcard';
      html.innerHTML = `
        <div class="q-idx">Task ${idx+1} of ${TRANSFORM.length}</div>
        <div style="color:rgba(230,238,246,0.75); font-size:14px">Original (for reference): <em>${it.origin}</em></div>
        <div class="sentence" style="margin-top:8px">${it.prompt.replace('___','<strong style="text-decoration:underline">______</strong>')}</div>

        <div style="margin-top:10px">
          <input id="transInput" class="trans-input" placeholder="Type your transformed sentence here">
          <div class="small-muted" style="margin-top:8px">Use the given word in the prompt. Answer is checked against accepted variants.</div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
          <button class="btn" id="prevTrans" ${idx===0?'disabled':''}>Previous</button>
          <button class="btn" id="nextTrans">Next</button>
        </div>
      `;
      mainArea.appendChild(html);

      const input = document.getElementById('transInput');
      input.value = transState.answers[idx] || '';
      input.focus();

      document.getElementById('prevTrans').onclick = ()=>{ transState.answers[idx] = input.value; if(idx>0){ transState.idx--; renderTrans(); } };
      document.getElementById('nextTrans').onclick = ()=>{ transState.answers[idx] = input.value; if(transState.idx === TRANSFORM.length - 1){ finishTrans(); } else { transState.idx++; renderTrans(); } };

      input.addEventListener('keydown', (ev)=>{ if(ev.key === 'Enter'){ document.getElementById('nextTrans').click(); }});
    }

    function normalizeForCompare(s){
      return normalizeAnswer(s).replace(/\b(a|the|to|that|did|do|does)\b/g,'').trim();
    }

    function finishTrans(){
      const total = TRANSFORM.length;
      let score = 0;
      const items = [];
      for(let i=0;i<total;i++){
        const raw = transState.answers[i] || "";
        const user = normalizeForCompare(raw);
        const valids = TRANSFORM[i].key.map(k => normalizeForCompare(k));
        // check: either exact match to a key OR key contained in user
        let ok = valids.some(v => v && (user === v || user.includes(v) || v.includes(user)));
        // fallback: if user empty => incorrect
        if(ok) score++;
        items.push({ qnum:i+1, user:raw||null, correct:TRANSFORM[i].key.join(' / '), isCorrect:ok, explanation:TRANSFORM[i].explain });
      }
      showScore(score, total, items);
    }

    /************************************************************************
     * SHARED: Score display & reveal answers
     ************************************************************************/
    function showScore(correct, total, items){
      scoreCard.classList.add('show');
      scoreCard.setAttribute('aria-hidden','false');

      // Animate numbers
      scoreNumber.textContent = `0 / ${total}`;
      scorePercent.textContent = `0% — Great effort!`;
      let frames = 30;
      let step = 0;
      const inc = correct / frames;
      let acc = 0;
      const interval = setInterval(()=>{
        acc += inc;
        const display = Math.round(acc);
        scoreNumber.textContent = `${display} / ${total}`;
        scorePercent.textContent = `${Math.round((display/total)*100)}%`;
        step++;
        if(step>=frames){
          clearInterval(interval);
          scoreNumber.textContent = `${correct} / ${total}`;
          const pct = Math.round((correct/total)*100);
          scorePercent.textContent = `${pct}% — ${pct>=85?'Outstanding!':pct>=65?'Very good':'Good practice — review answers'}`;
        }
      }, 12);

      // prepare answers list
      answersList.style.display = 'none';
      answersList.innerHTML = items.map(it => {
        const userText = it.user === null ? '<em>no answer</em>' : escapeHtml(it.user);
        const correctText = escapeHtml(it.correct);
        const flag = it.isCorrect ? '✅' : '❌';
        return `<div class="answer-item"><div><strong>Q${it.qnum}.</strong> ${flag} Your answer: <strong>${userText}</strong> — Correct: <strong>${correctText}</strong></div><div style="color:rgba(230,238,246,0.7); margin-top:6px">${escapeHtml(it.explanation||'')}</div></div>`;
      }).join('');

      revealAnswersBtn.style.display = 'inline-block';
      revealAnswersBtn.onclick = ()=>{ answersList.style.display = 'block'; revealAnswersBtn.style.display = 'none'; };

      closeScoreBtn.onclick = ()=>{ hideScore(); };
    }

    function hideScore(){
      scoreCard.classList.remove('show');
      scoreCard.setAttribute('aria-hidden','true');
      answersList.style.display = 'none';
      revealAnswersBtn.style.display = 'inline-block';
      answersList.innerHTML = '';
    }

    function escapeHtml(text){
      if(!text) return '';
      return String(text).replace(/[&<>"'`]/g, (s)=>({ '&': '&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;', '`':'&#96;' }[s]));
    }

    /************************************************************************
     * Event wiring: tiles + menu
     ************************************************************************/
    tiles.forEach(tile=>{
      tile.addEventListener('click', ()=> {
        const tgt = tile.dataset.target;
        if(tgt === 'mc') startMC();
        if(tgt === 'gap') startGap();
        if(tgt === 'word') startWord();
        if(tgt === 'trans') startTrans();
      });
      tile.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'||ev.key===' ') { ev.preventDefault(); tile.click(); }});
    });

    returnBtn.onclick = ()=>{ showMenu(); };

    // Start with menu
    showMenu();

    // Close score on Escape
    document.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Escape'){
        if(scoreCard.classList.contains('show')) hideScore();
        else showMenu();
      }
    });

  </script>
</body>
</html>
